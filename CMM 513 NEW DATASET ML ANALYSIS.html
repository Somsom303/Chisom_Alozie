#Loading libraries
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
import warnings
import seaborn as sns
import scipy
import sys

#Now import the CSV File
from pandas import read_csv
from pandas.plotting import scatter_matrix
from matplotlib import pyplot
from sklearn.model_selection import train_test_split
from sklearn.model_selection import cross_val_score
from sklearn.model_selection import StratifiedKFold
from sklearn.metrics import classification_report
from sklearn.metrics import confusion_matrix
from sklearn.metrics import accuracy_score
from sklearn.tree import DecisionTreeClassifier
from sklearn.neighbors import KNeighborsClassifier
from sklearn.ensemble import RandomForestClassifier
from sklearn.naive_bayes import GaussianNB
from sklearn.naive_bayes import BernoulliNB
from sklearn.svm import SVC

#removing warnings and defining x and y values ( Note: share the data in the ratio 80:20, where 80 is for training, and 20 is for testing)
warnings.filterwarnings("ignore")
mpd =pd.read_csv("MPdataset.csv")
x=mpd.iloc[:,0:80].values
y=mpd.iloc[:,80].values

#Ploting Class distribution pie chart of label
mpd['Label'].value_counts().plot(kind='pie',autopct='%1.2f%%')
plt.title("Class Distribution")
plt.show()

# To view the first 10 lines of data 
mpd.head()

# To view the main flow features 
mpd.isnull().sum()

#To view all the selected flow features for the ML analysis
print(mpd. columns)

#To know the length of Column names
len(colnames)

#Note flow features for detection of DDoS attacks output like this below:
colnames = ['Flow ID', 'Src IP', 'Src Port', 'Dst IP', 'Dst Port', 'Protocol',
       'Timestamp', 'Flow Duration', 'Tot Fwd Pkts', 'Tot Bwd Pkts',
       'TotLen Fwd Pkts', 'TotLen Bwd Pkts', 'Fwd Pkt Len Max',
       'Fwd Pkt Len Min', 'Fwd Pkt Len Mean', 'Fwd Pkt Len Std',
       'Bwd Pkt Len Max', 'Bwd Pkt Len Min', 'Bwd Pkt Len Mean',
       'Bwd Pkt Len Std', 'Flow Byts/s', 'Flow Pkts/s', 'Flow IAT Mean',
       'Flow IAT Std', 'Flow IAT Max', 'Flow IAT Min', 'Fwd IAT Tot',
       'Fwd IAT Mean', 'Fwd IAT Std', 'Fwd IAT Max', 'Fwd IAT Min',
       'Bwd IAT Tot', 'Bwd IAT Mean', 'Bwd IAT Std', 'Bwd IAT Max',
       'Bwd IAT Min', 'Fwd PSH Flags', 'Bwd PSH Flags', 'Fwd URG Flags',
       'Bwd URG Flags', 'Fwd Header Len', 'Bwd Header Len', 'Fwd Pkts/s',
       'Bwd Pkts/s', 'Pkt Len Min', 'Pkt Len Max', 'Pkt Len Mean',
       'Pkt Len Std', 'Pkt Len Var', 'FIN Flag Cnt', 'SYN Flag Cnt',
       'RST Flag Cnt', 'PSH Flag Cnt', 'ACK Flag Cnt', 'URG Flag Cnt',
       'CWE Flag Count', 'ECE Flag Cnt', 'Down/Up Ratio', 'Pkt Size Avg',
       'Fwd Seg Size Avg', 'Bwd Seg Size Avg', 'Fwd Byts/b Avg',
       'Fwd Pkts/b Avg', 'Fwd Blk Rate Avg', 'Bwd Byts/b Avg',
       'Bwd Pkts/b Avg', 'Bwd Blk Rate Avg', 'Subflow Fwd Pkts',
       'Subflow Fwd Byts', 'Subflow Bwd Pkts', 'Subflow Bwd Byts',
       'Fwd Act Data Pkts', 'Active Mean', 'Active Std', 'Active Max',
       'Active Min', 'Idle Mean', 'Idle Std', 'Idle Max', 'Idle Min', 'Label']

#lenght of col and data size
mpd.shape

#Get all the index of the flow features
num_cols = mpd._get_numeric_data().columns
print(num_cols)

#View the raw data ( flow features and value)
mpd.corr()

#Introducing Masking, which helps to remove duplicate charts
mask = np.zeros_like(mpd.corr())
triangle_indices = np.triu_indices_from(mask)
mask[triangle_indices] = True
mask

#Creating a heatmap for feature selection
plt.figure(figsize =(16, 10))
sns.heatmap(mpd.corr())
plt.xticks(fontsize=14)
plt.yticks(fontsize=14)
plt.show()

# Performing masking ( Dividing the mask diagonally)
plt.figure(figsize =(16, 10))
sns.heatmap(mpd.corr(), mask=mask)
plt.xticks(fontsize=14)
plt.yticks(fontsize=14)
plt.show()

Features = ['Src Port', 'Protocol', 'Tot Fwd Pkts', 'TotLen Fwd Pkts', 'Fwd Pkt Len Max', 
            'Fwd Pkt Len Mean', 'Bwd Pkt Len Max', 'Bwd Pkt Len Mean', 'Flow Byts/s', 'Flow IAT Mean', 
            'Flow IAT Max', 'Fwd IAT Tot', 'Fwd IAT Std', 'Fwd IAT Min', 'Bwd IAT Mean', 
            'Bwd IAT Max', 'Fwd Header Len', 'Fwd Pkts/s', 'Pkt Len Min', 'Pkt Len Mean', 
            'Pkt Len Var', 'SYN Flag Cnt', 'PSH Flag Cnt', 'Pkt Size Avg', 'Bwd Seg Size Avg', 
            'Subflow Fwd Byts', 'Subflow Bwd Byts', 'Active Mean', 'Active Max', 'Idle Mean', 'Idle Max']
target = 'Label'

#Length of features
len(Features)

#Define x, y variables, and the first five rows for X
x = mpd.loc[:,Features]
y = mpd.loc[:,target]
x.head()

#Percentage split 80% train, testing 20%
from sklearn.model_selection import train_test_split
x_train, x_test, y_train, y_test =train_test_split(x,y,train_size=0.8,test_size=0.2,random_state=42)

#Now select and run your Classifiers/ ML Models ( This script displays computation time, Accuracy of detection, Confusion Matrix, and report.
#For RF
RF = RandomForestClassifier()
classifiers1 = ["RF"]
scores = []

import time
s=time.time()
res1 = time.time()
RF.fit(x_train,y_train)
y_pred = RF.predict(x_test)
score = accuracy_score(y_test, y_pred)*100
scores.append(score)
res2 = time.time()
print('Random Forest took ',res2-res1,'seconds')
print("Accuracy of RF ", score )
conf_matrix = confusion_matrix(y_test,y_pred)
report = classification_report(y_test,y_pred)
print("Confusion Matrix:\n",conf_matrix)
print("Report:\n","class",report)
print("\n==============***===============")

#For SVM
SVM = SVC(random_state=0)
classifiers = ["SVC"]
scores = []

res1 = time.time()
SVM.fit(x_train,y_train)
y_pred = SVM.predict(x_test)
score = accuracy_score(y_test, y_pred)*100
scores.append(score)
res2 = time.time()
print('SVM took ',res2-res1,'seconds')
print("Accuracy of SVM ", score )
conf_matrix = confusion_matrix(y_test,y_pred)
report = classification_report(y_test,y_pred)
print("Confusion Matrix:\n",conf_matrix)
print("Report:\n","class",report)
print("\n==============***===============")

#For DT
DT = DecisionTreeClassifier()
classifiers3 = ["DecisionTree"]
scores = []

res1 = time.time()
DT.fit(x_train,y_train)
y_pred = DT.predict(x_test)
score = accuracy_score(y_test, y_pred)*100
scores.append(score)
res2 = time.time()
print('DT took ',res2-res1,'seconds')
print("Accuracy of DecisionTree ", score )
conf_matrix = confusion_matrix(y_test,y_pred)
report = classification_report(y_test,y_pred)
print("Confusion Matrix:\n",conf_matrix)
print("Report:\n","class",report)
print("\n==============***===============")

# For NB
NB = GaussianNB()
classifiers4 = ["NB"]
scores = []

res1 = time.time()
NB.fit(x_train,y_train)
y_pred = NB.predict(x_test)
score = accuracy_score(y_test, y_pred)*100
scores.append(score)
res2 = time.time()
print('NB took ',res2-res1,'seconds')
print("Accuracy of NB ", score )
conf_matrix = confusion_matrix(y_test,y_pred)
report = classification_report(y_test,y_pred)
print("Confusion Matrix:\n",conf_matrix)
print("Report:\n","class",report)
print("\n==============***===============")

# For KNN
KNN = KNeighborsClassifier(n_neighbors=3)
classifiers5 = ["KNN"]
scores = []

res1 = time.time()
KNN.fit(x_train,y_train)
y_pred = KNN.predict(x_test)
score = accuracy_score(y_test, y_pred)*100
scores.append(score)
res2 = time.time()
print('KNN took ',res2-res1,'seconds')
print("Accuracy of KNN ", score )
conf_matrix = confusion_matrix(y_test,y_pred)
report = classification_report(y_test,y_pred)
print("Confusion Matrix:\n",conf_matrix)
print("Report:\n","class",report)
print("\n==============***===============")

# Plot bar chart for the report 
import matplotlib.pyplot as plt
fig = plt.figure()
ax = fig.add_axes([0,0,1,1])
Models = ['RF', 'SVM', 'DT', 'NB', 'KNN']
scores = [100.00,99.63,99.98,98.29,99.81]
ax.bar(Models,scores)
plt.show()

#Cross Validation 
from sklearn.model_selection import cross_val_score,KFold
from sklearn.model_selection import cross_val_score,StratifiedKFold

# Replace each classifier with its name and run the code.
import time
s=time.time()
res1 = time.time()
RF=RandomForestClassifier()
stratifiedkf=StratifiedKFold(n_splits=5)
score=cross_val_score(RF,x,y,cv=stratifiedkf)
res2 = time.time()
print('RF took ',res2-res1,'seconds')
print("Cross Validation Scores are {}".format(score))
print("Average Cross Validation score :{}".format(score.mean()*100))

#bar plot for validation set
import matplotlib.pyplot as plt
fig = plt.figure()
ax = fig.add_axes([0,0,1,1])
Models = ['RF', 'SVM', 'DT', 'NB', 'KNN']
scores = [99.88,99.61,99.84,98.11,99.57]
ax.bar(Models,scores)
plt.show()
